package net.aincraft.payment;

import com.google.inject.Inject;
import java.util.Arrays;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;
import net.aincraft.util.LocationKey;
import org.bukkit.Chunk;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.world.ChunkUnloadEvent;

final class ExploitStoreController implements Listener {

  private final ExploitService exploitService;

  @Inject
  ExploitStoreController(ExploitService exploitService) {
    this.exploitService = exploitService;
  }

  @EventHandler(priority = EventPriority.MONITOR, ignoreCancelled = true)
  private void onPlayerUnloadChunk(final ChunkUnloadEvent event) {
    Chunk chunk = event.getChunk();
    String world = chunk.getWorld().getName();
    int chunkX = chunk.getX();
    int chunkZ = chunk.getZ();

    // Cleanup block-based protection timers (LocationKey)
    exploitService.cleanupWhere(key -> {
      if (key instanceof LocationKey lk) {
        return lk.worldName().equals(world)
            && (lk.x() >> 4) == chunkX
            && (lk.z() >> 4) == chunkZ;
      }
      return false;
    });

    // Cleanup entity-based protection timers (UUID)
    Set<UUID> entityIds = Arrays.stream(chunk.getEntities())
        .map(org.bukkit.entity.Entity::getUniqueId)
        .collect(Collectors.toSet());
    exploitService.cleanupWhere(entityIds::contains);
  }
}
